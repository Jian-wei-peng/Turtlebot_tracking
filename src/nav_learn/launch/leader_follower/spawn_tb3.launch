<launch>
    <arg name="model"    default="$(env TURTLEBOT3_MODEL)" doc="model type [burger, waffle, waffle_pi]"/>
    <arg name="leader"   default="leader"/>
    <arg name="follower" default="follower"/>

    <arg name="leader_x_pos" default="-1.0"/>
    <arg name="leader_y_pos" default="-0.5"/>
    <arg name="leader_z_pos" default=" 0.0"/>
    <arg name="leader_yaw"   default=" 0.0"/>

    <arg name="follower_x_pos" default="-2.5"/>
    <arg name="follower_y_pos" default="-0.5"/>
    <arg name="follower_z_pos" default=" 0.0"/>
    <arg name="follower_yaw"   default=" 0.0"/>

    <arg name="front_distance" default = "-0.032" />

    <!-- Map server -->
    <arg name="map_file" default="$(find nav_learn)/maps/tb3_world.yaml"/>

    <!-- 启动Gazebo -->
    <include file="$(find gazebo_ros)/launch/empty_world.launch">
        <arg name="world_name" value="$(find turtlebot3_gazebo)/worlds/turtlebot3_world.world"/>
        <arg name="paused" value="false"/>
        <arg name="use_sim_time" value="true"/>
        <arg name="gui" value="true"/>
        <arg name="headless" value="false"/>
        <arg name="debug" value="false"/>
    </include>  

    <!-- 生成 Leader 机器人 -->
    <group ns = "$(arg leader)">
        <!-- 将模型文件写入参数服务器 -->
        <param name="robot_description" command="$(find xacro)/xacro --inorder $(find turtlebot3_description)/urdf/turtlebot3_$(arg model).urdf.xacro name_space:=$(arg leader)" />

        <!-- 解析 URDF 计算 TF 树并发布变换 -->
        <node pkg="robot_state_publisher" type="robot_state_publisher" name="robot_state_publisher" output="screen">
            <param name="publish_frequency" type="double" value="50.0" />
            <param name="tf_prefix" value="$(arg leader)" />
        </node>
        <node name="joint_state_publisher" pkg="joint_state_publisher" type="joint_state_publisher"/>

        <!-- 在 gazebo 中显示机器人模型 -->
        <node pkg="gazebo_ros" type="spawn_model" name="leader" args="-urdf -model $(arg leader) 
                                                                      -x $(arg leader_x_pos) 
                                                                      -y $(arg leader_y_pos) 
                                                                      -z $(arg leader_z_pos) 
                                                                      -Y $(arg leader_yaw) 
                                                                      -param robot_description"/>
    </group>

    <!-- 生成 Follower 机器人 -->
    <group ns = "$(arg follower)">
        <param name="robot_description" command="$(find xacro)/xacro --inorder $(find turtlebot3_description)/urdf/turtlebot3_$(arg model).urdf.xacro name_space:=$(arg follower)" />  
        
        <node pkg="robot_state_publisher" type="robot_state_publisher" name="robot_state_publisher" output="screen">
            <param name="publish_frequency" type="double" value="50.0" />
            <param name="tf_prefix" value="$(arg follower)" />
        </node>
        <node name="joint_state_publisher" pkg="joint_state_publisher" type="joint_state_publisher"/>

        <node pkg="gazebo_ros" type="spawn_model" name="follower" args="-urdf -model $(arg follower) 
                                                                        -x $(arg follower_x_pos)
                                                                        -y $(arg follower_y_pos) 
                                                                        -z $(arg follower_z_pos) 
                                                                        -Y $(arg follower_yaw) 
                                                                        -param robot_description" />
    </group>

    <node pkg="tf2_ros" type="static_transform_publisher" name="world_to_leader_odom"   args="0 0 0 0 0 0 world $(arg leader)/odom" />
    <node pkg="tf2_ros" type="static_transform_publisher" name="world_to_follower_odom" args="0 0 0 0 0 0 world $(arg follower)/odom" />
    
    <node pkg="nav_learn" type="leader_follower.py" name="leader_follower" output="screen">
        <param name="leader_robot_name" value="$(arg leader)" />
        <param name="follower_robot_name" value="$(arg follower)" />
        <param name="expected_distance" value="1" />
        <param name="expected_theta" value="$(eval -3.1415926)" />
        <param name="front_distance" value="$(arg front_distance)" />
    </node>

    <node pkg="rviz" type="rviz" name="rviz" args="-d $(find nav_learn)/rviz/lf.rviz" />

</launch>

